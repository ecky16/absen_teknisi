<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Absen PSN â€” v2.6</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    :root {
      --bg: #0d0d0f;
      --card: #17171b;
      --text: #f5f7fb;
      --muted: #aab0bd;
      --danger: #ff4d4f;
      --brand: #b40000;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif; color: var(--text); background: var(--bg); }
    header { background: var(--brand); padding: 16px; text-align: center; position: sticky; top: 0; z-index: 2; }
    header h1 { margin:0; font-size: 18px; letter-spacing:.2px }

    main { max-width: 760px; margin: 18px auto; padding: 0 16px; }
    .board { background: var(--card); border: 1px solid #22252b; border-radius: 14px; padding: 18px; text-align: center; box-shadow: 0 8px 24px rgb(0 0 0 / .25); }

    .qr-wrap { display: inline-block; background: #fff; padding: 18px; border-radius: 10px; box-shadow: 0 0 0 1px #fff; }
    canvas#qr { display:block; image-rendering: pixelated; }

    .sub { margin-top: 10px; font-size: 14px; color: var(--muted); }
    .token { margin-top: 8px; font-size: 15px; color: #7CFC00; word-break: break-all; }
    .time { margin-top: 2px; font-size: 14px; color: #d7d9de; }

    .status { margin-top: 12px; font-size: 13px; color: var(--muted); }
    .status.ok { color: #00d68f; }
    .status.err { color: #ff4d4f; }

    .actions { margin-top: 12px; }
    .actions a { background:#21242a; color:#fff; border:1px solid #2a2e35; padding:8px 12px; border-radius:12px; text-decoration:none; display:inline-block; }

    footer { text-align:center; color:#8b90a0; font-size:12px; margin: 18px 0 28px; }

    @media (max-width: 420px){ header h1 { font-size: 16px; } }
  </style>
</head>
<body>
  <header><h1>ðŸ“¸ QR Absen â€” Area PSN</h1></header>
  <main>
    <section class="board">
      <div class="qr-wrap"><canvas id="qr" width="360" height="360" aria-label="Kode QR"></canvas></div>
      <div class="sub" id="note">Auto-refresh setiap <b><span id="refreshSec">2</span>s</b>.</div>
      <div class="token" id="tokenDisplay">Memuat tokenâ€¦</div>
      <div class="time" id="waktu">â€”</div>
      <div class="status" id="status">Siap.</div>
      <div class="actions"><a href="login.html">Ganti Area</a></div>
    </section>
    <footer>SAPA QR v2.6 â€¢ 2025</footer>
  </main>

<script>
(() => {
  // === LOGIN GUARD (cluster) ===
  const REQUIRED_AUTH = "7qvt6";
  const clusterKey = sessionStorage.getItem('clusterKey') || localStorage.getItem('clusterKey') || sessionStorage.getItem('loginQR');
  if (!clusterKey || clusterKey !== REQUIRED_AUTH) {
    alert("ðŸ”’ Akses ditolak. Silakan login dahulu.");
    location.href = "login.html";
    return;
  }

  // === KONFIG ===
  const AREA = "PSN"; // fixed
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzjYLOPjkm8GvbxCgLFbysK16n1nh6YRTgmKFn7oQTGfNSS9t85JkXwfoAXEHkHbEvVXg/exec";
  const BOT_DEEPLINK_BASE = "https://t.me/absensi_qr_bot?start=";
  const INTERVAL_MS = 2000;
  const FETCH_TIMEOUT = 8000;
  const QR_MAX = 420, QR_MIN = 220;

  // === Profil interval siang/malam + jitter ===
// Jam siang: 06:00 s.d. 21:59 (bisa kamu ubah)
const DAY_START = 6;
const DAY_END   = 22;

// Interval dasar
const INTERVAL_DAY_MS   = 2000; // 2s saat siang
const INTERVAL_NIGHT_MS = 8000; // 8s saat malam (boleh 10000 kalau mau 10s)

// Jitter untuk desinkronisasi antar layar (0â€“500 ms)
const JITTER_MS = 500;

function isNight() {
  const h = new Date().getHours();
  return !(h >= DAY_START && h < DAY_END);
}
function withJitter(base) {
  return base + Math.floor(Math.random() * JITTER_MS);
}
function currentBaseInterval() {
  return isNight() ? INTERVAL_NIGHT_MS : INTERVAL_DAY_MS;
}


  const elQR = document.getElementById('qr');
  const elToken = document.getElementById('tokenDisplay');
  const elTime = document.getElementById('waktu');
  const elStatus = document.getElementById('status');
  const elRefreshSec = document.getElementById('refreshSec');
  elRefreshSec.textContent = (INTERVAL_MS/1000).toString();

  function computeQRSize(){
    const vw = Math.min(window.innerWidth, 760) - 64;
    return Math.max(QR_MIN, Math.min(QR_MAX, Math.floor(vw)));
  }
  function resizeQR(){
    const s = computeQRSize();
    qr.set({ size: s });
  }
  const qr = new QRious({ element: elQR, value: 'Memuatâ€¦', size: computeQRSize(), level: 'H', background: '#ffffff', foreground: '#000000' });
  window.addEventListener('resize', resizeQR);

  let lastToken = '';
  let lastLink = '';
  let timer = null;
  let backoff = 0;

  function setStatus(msg, ok=false, err=false){
    elStatus.textContent = msg;
    elStatus.classList.toggle('ok', ok);
    elStatus.classList.toggle('err', err);
  }
  function fmtNow(){
    const now = new Date();
    const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    elTime.textContent = now.toLocaleDateString('id-ID', opts) + ' â€¢ ' + now.toLocaleTimeString('id-ID');
  }
  setInterval(fmtNow, 1000); fmtNow();

  function buildLink(token){
    return BOT_DEEPLINK_BASE + encodeURIComponent(token + "_" + AREA);
  }

  async function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, { cache:'no-store', signal: ctrl.signal });
      return res;
    } finally { clearTimeout(id); }
  }

  async function fetchToken(){
    const url = `${GAS_URL}?action=getToken&area=${encodeURIComponent(AREA)}&t=${Date.now()}`;
    try {
      setStatus('Mengambil tokenâ€¦');
      const res = await fetchWithTimeout(url, FETCH_TIMEOUT);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data || !data.token) throw new Error('Format respons tidak valid');

      const tokenNow = String(data.token);
      elToken.textContent = 'Token: ' + tokenNow;

      if (tokenNow !== lastToken){
        lastToken = tokenNow;
        lastLink = buildLink(tokenNow);
        qr.value = lastLink;
      }

      setStatus('Tersambung', true, false);
      backoff = 0;
    } catch (err){
      console.error('fetchToken error:', err);
      const msg = (err && err.name === 'AbortError') ? 'Timeout mengambil token' : (err && err.message ? err.message : String(err));
      setStatus('Gagal: ' + msg, false, true);
      if (!lastToken) {
        qr.value = 'Token belum tersedia';
      }
    }
  }

function startPolling(){
  stopPolling();
  const tick = async () => {
    await fetchToken();

    // hitung base interval (siang/malam) + backoff + jitter
    const base = currentBaseInterval();
    const backoffMul = elStatus.classList.contains('err') ? Math.min(16, 2 ** backoff) : 1; // 1,2,4,8,16
    const delay = withJitter(base * backoffMul);

    // naikkan backoff hanya saat error; reset kalau sukses
    if (elStatus.classList.contains('err')) backoff = Math.min(backoff + 1, 4);
    else backoff = 0;

    timer = setTimeout(tick, delay);
  };

  // startup delay: sedikit jitter supaya tidak bareng dengan device lain
  timer = setTimeout(tick, withJitter(200));
}

  function stopPolling(){ if (timer) { clearTimeout(timer); timer = null; } }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopPolling(); }
    else { startPolling(); fetchToken(); }
  });

  startPolling();
})();
</script>
</body>
</html>

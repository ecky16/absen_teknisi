<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Absen</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    #datetime {
      text-align: center;
      margin-bottom: 30px;
    }
    #date { font-size: 28px; }
    #clock { font-size: 60px; margin-top: 10px; }
    #password-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    input {
      padding: 10px;
      font-size: 20px;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #error-message {
      color: red;
      margin-top: 10px;
    }
    #qr-section {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    #qr-image { margin-top: 20px; }
  </style>
</head>
<body>

  <!-- FORM PASSWORD -->
  <div id="password-form">
    <input type="text" id="passwordInput" placeholder="Masukkan Password" autocomplete="off" />
    <button onclick="checkPassword()">Masuk</button>
    <div id="error-message"></div>
  </div>

  <!-- QR MODE -->
  <div id="qr-section">
    <div id="datetime">
      <div id="date">Memuat tanggal...</div>
      <div id="clock">00:00:00</div>
    </div>
    <img id="qr-image" src="" width="220" />
  </div>

  <script>
    const SCRIPT_ID = 'AKfycbyTngIjAKyIKM3JvMmUF0iHXnspbyiTslbd3qnU_QQ13muocEl_431Wp-cdGd-qvZgO';
    const SHEET_ID = '1wqYmtZ_PS8Ao-gpCBjqdSi1MmzotBmZa1BeALFmUuu4';
    const sheetAPI = `https://opensheet.elk.sh/${SHEET_ID}/token_qr`;
    let lastToken = "";

    function updateClock() {
      const now = new Date();
      const hari = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
      const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      document.getElementById('date').innerText = `${hari[now.getDay()]}, ${now.getDate()} ${bulan[now.getMonth()]} ${now.getFullYear()}`;
      document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID');
    }

    function startClock() {
      updateClock();
      setInterval(updateClock, 1000);
    }

    async function checkPassword() {
      const input = document.getElementById('passwordInput').value.trim();
      const errorBox = document.getElementById('error-message');
      errorBox.textContent = '⏳ Memeriksa...';

      try {
        const res = await fetch(`https://script.google.com/macros/s/${SCRIPT_ID}/exec?pass=${input}`);
        const data = await res.json();
        if (data.valid) {
          sessionStorage.setItem('qr_login', 'true');
          showQR();
        } else {
          errorBox.textContent = '❌ Password salah';
        }
      } catch (err) {
        errorBox.textContent = '⚠️ Gagal menghubungi server';
      }
    }

    async function showQR() {
      document.getElementById('password-form').style.display = 'none';
      document.getElementById('qr-section').style.display = 'flex';
      startClock();
      await fetchAndRenderQR();
      setInterval(fetchAndRenderQR, 5000);
    }

    async function fetchAndRenderQR() {
      try {
        const res = await fetch(sheetAPI + `?rand=${Math.random()}`);
        const rows = await res.json();
        const keys = Object.keys(rows[0]);
        const tokenKey = keys.find(k => k.toLowerCase().includes("token"));
        const token = rows[0][tokenKey];

        if (!token || token === lastToken) return;
        lastToken = token;

        const qrLink = `https://t.me/absen_TA_bot/absen_teknisi?startapp=${token}`;
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrLink)}`;
      } catch (err) {
        document.getElementById('qr-image').alt = '❌ QR gagal dimuat';
      }
    }

    // AUTO LOGIN jika masih sesi aktif
    if (sessionStorage.getItem('qr_login') === 'true') {
      showQR();
    }

    // AUTO LOGOUT saat tab/browser ditutup
    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('qr_login');
    });
  </script>
</body>
</html>
